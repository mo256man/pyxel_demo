<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>pyxel run (SHA-based) launcher</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding: 20px; }
    button { font-size: 16px; padding: 10px 14px; margin: 6px; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    iframe { width: 100%; height: 640px; border: 1px solid #ccc; margin-top: 12px; }
    small { color: #666; }
    .status { margin: 8px 0; padding: 8px; background: #f0f0f0; border-radius: 4px; font-size: 14px; }
    .status.error { background: #ffe0e0; color: #c00; }
    .status.success { background: #e0ffe0; color: #060; }
  </style>
</head>
<body>
  <h2>Pyxel (SHA-based) launcher</h2>
  <p>目的：コミット SHA を含む一意の CDN パスを使用して web_game.py を読み込み、jsDelivr エッジキャッシュによる古いコンテンツ配信を根本的に防ぎます。</p>

  <p>
    <button id="open-new">Launch (open in new tab)</button>
    <button id="open-iframe">Launch (embed iframe)</button>
  </p>

  <p><small>注意：このランチャーは GitHub API から最新のコミット SHA を取得し、jsDelivr のコンテンツアドレス URL を使用します。API が失敗した場合は raw.githubusercontent にフォールバックします。</small></p>

  <div id="status" class="status" style="display: none;"></div>
  <div id="frame-container"></div>

  <script>
    // リポジトリ設定
    const OWNER = 'mo256man';
    const REPO = 'pyxel_demo';
    const BRANCH = 'main';

    // 変更したいモジュール名（そのまま run パラメータへ）
    const runParam = encodeURIComponent('mo256man.pyxel_demo.web_game');

    /**
     * GitHub API から指定ブランチの最新コミット SHA を取得する。
     * sessionStorage にキャッシュして、同一セッション内での重複リクエストを回避する。
     * @param {string} owner リポジトリオーナー
     * @param {string} repo リポジトリ名
     * @param {string} branch ブランチ名
     * @returns {Promise<string>} コミット SHA（フル40文字）
     */
    async function resolveSha(owner, repo, branch) {
      const key = `${owner}_${repo}_${branch}_sha`;
      const cached = sessionStorage.getItem(key);
      if (cached) {
        console.log('[Launcher] Using cached SHA:', cached);
        return cached;
      }
      const url = `https://api.github.com/repos/${owner}/${repo}/commits/${branch}`;
      const res = await fetch(url);
      if (!res.ok) {
        throw new Error(`GitHub API failed (${url}): ${res.status} ${res.statusText}`);
      }
      const json = await res.json();
      const sha = json.sha;
      sessionStorage.setItem(key, sha);
      console.log('[Launcher] Fetched SHA from GitHub API:', sha);
      return sha;
    }

    /**
     * SHA ベースの jsDelivr CDN URL を使用してランチャー URL を構築する。
     * GitHub API が失敗した場合は raw.githubusercontent にフォールバックする。
     * @returns {Promise<{url: string, source: string}>} ランチャー URL とソース情報
     */
    async function buildLauncherUrl() {
      try {
        const sha = await resolveSha(OWNER, REPO, BRANCH);
        // SHA ベースの jsDelivr URL を構築
        // 形式: https://cdn.jsdelivr.net/gh/owner/repo@sha/
        const cdnRoot = `https://cdn.jsdelivr.net/gh/${OWNER}/${REPO}@${sha}`;
        const rootParam = encodeURIComponent(cdnRoot);
        const url = `https://kitao.github.io/pyxel/wasm/launcher/?run=${runParam}&root=${rootParam}`;
        return { url, source: `jsDelivr (SHA: ${sha.substring(0, 7)})` };
      } catch (error) {
        console.warn('[Launcher] GitHub API failed, falling back to raw.githubusercontent:', error.message);
        // フォールバック: raw.githubusercontent を使用（タイムスタンプでキャッシュバスト）
        const t = Date.now();
        const rawRoot = encodeURIComponent(`https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}`);
        const url = `https://kitao.github.io/pyxel/wasm/launcher/?run=${runParam}&root=${rawRoot}&t=${t}`;
        return { url, source: 'raw.githubusercontent (fallback)' };
      }
    }

    /**
     * ステータスメッセージを表示する
     * @param {string} message メッセージ
     * @param {'info'|'success'|'error'} type メッセージタイプ
     */
    function showStatus(message, type = 'info') {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.className = 'status' + (type !== 'info' ? ` ${type}` : '');
      statusEl.style.display = 'block';
    }

    /**
     * ランチャーを新しいタブで開く
     */
    async function launchInNewTab() {
      const btn = document.getElementById('open-new');
      btn.disabled = true;
      showStatus('SHA を取得中...');
      try {
        const { url, source } = await buildLauncherUrl();
        showStatus(`起動中... (${source})`, 'success');
        window.open(url, '_blank');
      } catch (error) {
        showStatus(`エラー: ${error.message}`, 'error');
      } finally {
        btn.disabled = false;
      }
    }

    /**
     * ランチャーを iframe で埋め込む
     */
    async function launchInIframe() {
      const btn = document.getElementById('open-iframe');
      btn.disabled = true;
      showStatus('SHA を取得中...');
      try {
        const { url, source } = await buildLauncherUrl();
        showStatus(`読み込み中... (${source})`, 'success');
        const container = document.getElementById('frame-container');
        container.innerHTML = '';
        const ifr = document.createElement('iframe');
        ifr.src = url;
        container.appendChild(ifr);
        ifr.scrollIntoView({ behavior: 'smooth' });
      } catch (error) {
        showStatus(`エラー: ${error.message}`, 'error');
      } finally {
        btn.disabled = false;
      }
    }

    document.getElementById('open-new').addEventListener('click', launchInNewTab);
    document.getElementById('open-iframe').addEventListener('click', launchInIframe);
  </script>
</body>
</html>
